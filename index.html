<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockClan Records</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%23222236'/%3E%3Cpath d='M82 30 56 64l26 34-18 0-26-34 26-34z' fill='%23ff6a00'/%3E%3C/svg%3E">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <style>
    :root{ --bg1:#0b0710;--bg2:#14050a;--accent:#ff6a00;--muted:#a7a0a8;--card:rgba(255,255,255,0.03); }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;margin:0;color:#eee;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    header h1{margin:0;color:var(--accent)}
    header .sub{color:var(--muted);font-size:13px;margin-top:6px}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#14141a;position:sticky;top:0;z-index:2}
    nav button{background:#1a1a22;border:1px solid #232532;color:#ddd;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--accent);color:#111}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:center}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.03)}
    .tier-Stone{color:#8b8b8b}.tier-Bronze{color:#cd7f32}.tier-Silver{color:#c0c0c0}.tier-Gold{color:#ffd700}.tier-Diamond{color:#67e8f9}.tier-Legend{color:#ff7f50}
    .muted{color:var(--muted)}
    .match{border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px;cursor:pointer}
    .details{display:none;margin-top:8px;font-size:14px;color:#ddd}
    .details.active{display:block}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .filters > *{flex:1 1 160px}
    .rank-badge{background:#252532;border:1px solid #2f3140;border-radius:8px;padding:2px 8px;font-weight:700;display:inline-block;margin-right:6px}
    .note{font-size:12px;color:#aaa;margin-top:6px}
  </style>
</head>

<body>
  <header>
    <h1>RockClan Records</h1>
    <div class="sub">클랜원 랭킹 • 기록실 • ELO 설명 • 변동 그래프</div>
  </header>

  <nav>
    <button class="tab active" data-tab="players">클랜원 랭킹</button>
    <button class="tab" data-tab="records">기록실</button>
    <button class="tab" data-tab="elo-info">ELO 시스템 설명</button>
    <button class="tab" data-tab="chart">ELO 변동 그래프</button>
  </nav>

  <main>
    <section id="players" class="active">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">클랜원 랭킹</h2>
        <div class="filters">
          <input id="search" placeholder="id 검색" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
          <select id="raceFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
            <option value="">종족 전체</option><option>Protoss</option><option>Terran</option><option>Zerg</option><option>Random</option>
          </select>
          <select id="tierFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
            <option value="">티어 전체</option><option>Stone</option><option>Bronze</option><option>Silver</option><option>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </div>
        <div class="muted" style="font-size:13px;margin-bottom:6px">전체 인원, 종족/티어, 현재 ELO, 승률(%) — <span id="counts"></span></div>
        <table id="players-table">
          <thead><tr><th>Rank</th><th>ID</th><th>종족</th><th>티어</th><th>ELO</th><th>승</th><th>패</th><th>승률</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="note">* 승/패/승률은 기록실(match)을 기반으로 자동 재계산됩니다.</div>
      </div>
    </section>

    <section id="records">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">기록실 (클릭하여 접기/펼치기)</h2>
        <div id="match-list"></div>
      </div>
    </section>
    <section id="elo-info">
  <div class="card">
    <h2 style="margin:6px 0;color:var(--accent)">ELO 시스템 설명</h2>
    <p style="line-height:1.6;color:#ddd">
      ELO(이로) 시스템은 각 플레이어의 상대 전력을 수치로 표현하는 방식입니다.<br>
      RockClan에서는 모든 <b>기록실(match)</b> 데이터를 기반으로 자동 계산되며,
      JSON에 기록된 <code>history</code>는 참고용으로만 사용됩니다.
    </p>
    <ul style="line-height:1.8;color:#ccc;margin-left:12px">
      <li><b>초기 ELO</b>: 모든 신규 플레이어는 <b>1000점</b>에서 시작합니다.</li>
      <li><b>K 값</b> (변동 계수):
        <ul>
          <li>개인전(1:1): <b>K = 12</b></li>
          <li>팀전(2:2, 3:3, 4:4 등): <b>K = 8</b></li>
        </ul>
      </li>
      <li>
        경기 결과에 따라 예상 승률(Expected Score)과 실제 결과(Actual Score)의 차이를 반영해 ELO가 변동됩니다.<br>
        예를 들어, 약자가 강자를 이길 경우 ELO 상승폭이 크며, 강자가 약자를 이길 경우 상승폭이 작습니다.
      </li>
      <li>
        팀전의 경우 팀 평균 ELO를 기준으로 상대 팀과 비교하여 승패 결과를 반영합니다.
      </li>
      <li>
        <b>승/패, 경기 수</b>는 모든 기록실 데이터를 기준으로 자동 집계되며, 이중 계산이나 누락이 발생하지 않습니다.
      </li>
      <li>
        경기 데이터(`map: "Match"`)는 요약용 헤더이며, ELO에는 포함되지 않습니다.
      </li>
    </ul>
    <p style="margin-top:10px;color:#999">
      ※ 본 시스템은 K값 조정을 통해 변동 폭을 안정화시켰으며,<br>
      팀전 비중이 높은 플레이어도 ELO 변동이 과도하지 않도록 설계되었습니다.
    </p>
  </div>
</section>

  </main>

<script>
  // 탭 전환
  document.querySelectorAll('nav .tab').forEach(btn=>{
    btn.addEventListener('click', e=>{
      document.querySelectorAll('nav .tab').forEach(b=>b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
      document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
    });
  });

  // --- 데이터 로드 ---
  function start(){
    Promise.all([
      fetch('data.json',{cache:'no-cache'}).then(r=>r.json()),
      fetch('data_oct.json',{cache:'no-cache'}).then(r=>r.json())
    ])
    .then(([sep, oct]) => {
      sep.matches.push(...oct.matches);
      renderAll(sep);
    })
    .catch(e=>console.error('로드 실패',e));
  }

  // 날짜 & Match 그룹화
  function groupByMatch(matches){
    const groups=[]; 
    let current=null; 
    let currentDate=''; 
    let idx=0;

    for(const m of matches){
      const key = m.date;
      const isHeader = (m.map === 'Match');

      if(!current || currentDate!==key || isHeader){
        if(isHeader){
          idx = (current && currentDate===key) ? idx+1 : 1;
          current = {date:m.date, index:idx, header:m, sets:[]};
          groups.push(current);
        }else{
          if(!current || currentDate!==key){
            idx = 1;
            current = {date:m.date, index:idx, header:null, sets:[]};
            groups.push(current);
          }
        }
        currentDate = key;
      }

      if(isHeader){ 
        current.header = m; 
      }else{ 
        current.sets.push(m); 
      }
    }
    return groups;
  }

  // --- 렌더링 ---
  function renderAll(data){
    const tbody=document.querySelector('#players-table tbody');
    const s=document.getElementById('search');
    const rf=document.getElementById('raceFilter');
    const tf=document.getElementById('tierFilter');

    // 신규 플레이어 초기화
    function ensurePlayer(id){
      let p=data.players.find(p=>p.id===id);
      if(!p){
        p={id,race:'Protoss',tier:'Silver',elo:1000,played:0,win:0,loss:0};
        data.players.push(p);
      }
      return p;
    }

    // --- 승패 집계 ---
    const stat = new Map();
    const ensureStat = id => stat.get(id) || stat.set(id,{played:0,win:0,loss:0}).get(id);
    const addResult = (winners, losers)=>{
      winners.forEach(id=>{const s=ensureStat(id); s.played++; s.win++;});
      losers.forEach(id=>{const s=ensureStat(id); s.played++; s.loss++;});
    };

    for(const m of data.matches){
      if(m.map === "Match") continue;
      if(m.player1 && m.player2){
        const p1=m.player1, p2=m.player2, w=m.winner;
        if(w===p1) addResult([p1],[p2]);
        else if(w===p2) addResult([p2],[p1]);
        else { ensureStat(p1).played++; ensureStat(p2).played++; }
        continue;
      }
      if(Array.isArray(m.team1)&&Array.isArray(m.team2)){
        const t1=m.team1,t2=m.team2;
        const winners=Array.isArray(m.winner)?m.winner:[]; 
        const wset=new Set(winners);
        const all=[...t1,...t2];
        const losers=all.filter(x=>!wset.has(x));
        if(winners.length && losers.length) addResult(winners,losers);
        else all.forEach(id=>ensureStat(id).played++);
      }
    }

    // --- ELO 계산 ---
    data.players.forEach(p=>p.elo=1000); // 초기화

    for(const m of data.matches){
      if(m.map === "Match") continue;

      // 1:1 경기
      if(m.player1 && m.player2){
        const p1=ensurePlayer(m.player1);
        const p2=ensurePlayer(m.player2);
        if(!m.winner) continue;

        const K = 12; // ⚙️ 1:1 전용 K값
        const expected1 = 1 / (1 + Math.pow(10, (p2.elo - p1.elo) / 400));
        const expected2 = 1 - expected1;
        const result1 = m.winner === p1.id ? 1 : 0;
        const result2 = 1 - result1;
        p1.elo += K * (result1 - expected1);
        p2.elo += K * (result2 - expected2);
      } 
      // 팀전
      else if(Array.isArray(m.team1) && Array.isArray(m.team2)){
        const t1 = m.team1.map(ensurePlayer);
        const t2 = m.team2.map(ensurePlayer);
        const avg1 = t1.reduce((a,b)=>a+b.elo,0)/t1.length;
        const avg2 = t2.reduce((a,b)=>a+b.elo,0)/t2.length;
        const winSet = new Set(m.winner || []);
        const team1Win = m.team1.some(id=>winSet.has(id));

        const K = 8; // ⚙️ 팀전 전용 K값
        const expected1 = 1 / (1 + Math.pow(10, (avg2 - avg1)/400));
        const result1 = team1Win ? 1 : 0;
        const diff = K * (result1 - expected1);

        t1.forEach(p => p.elo += diff);
        t2.forEach(p => p.elo -= diff);
      }
    }

    // --- 승패/경기수 반영 ---
    for(const [id,s] of stat.entries()){
      const p=ensurePlayer(id);
      p.played=s.played; p.win=s.win; p.loss=s.loss;
    }

    // --- 표 렌더링 ---
    function render(){
      tbody.innerHTML='';
      const kw=(s.value||'').toLowerCase(), race=rf.value, tier=tf.value;
      const sorted=[...data.players]
        .sort((a,b)=>b.elo-a.elo)
        .filter(p=>(!kw||p.id.toLowerCase().includes(kw))&&(!race||p.race===race)&&(!tier||p.tier===tier));
      sorted.forEach((p,i)=>{
        const wr=p.played?((p.win/p.played)*100).toFixed(1)+'%':'-';
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><span class="rank-badge">${i+1}</span></td>
          <td>${p.id}</td>
          <td>${p.race}</td>
          <td class="tier-${p.tier}">${p.tier}</td>
          <td>${Math.round(p.elo)}</td>
          <td>${p.win}</td>
          <td>${p.loss}</td>
          <td>${wr}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('counts').textContent=
        `Players: ${data.players.length} | Matches: ${data.matches.length}`;
    }
    s.addEventListener('input',render);
    rf.addEventListener('change',render);
    tf.addEventListener('change',render);
    render();

    // --- 기록실 ---
    const list = document.getElementById('match-list');
    list.innerHTML = '';
    const groups = groupByMatch(
      [...data.matches].sort((a, b) => a.date.localeCompare(b.date))
    );

    groups.forEach((g,gi) => {
      const box = document.createElement('div');
      box.className = 'match';
      if (gi > 0) box.style.marginTop = '12px';

      const head = document.createElement('div');
      const matchCount = g.sets ? g.sets.length : 0;
      head.innerHTML = `<b>${g.date}</b> | Match ${g.index} (${matchCount}개 세트)`;
      const det = document.createElement('div');
      det.className = 'details';

      if (!g.sets || g.sets.length === 0) {
        det.innerHTML = '<div class="muted">세트 기록 없음</div>';
      } else {
        g.sets.forEach(m => {
          const row = document.createElement('div');
          let s = `• ${m.map} — `;
          if (Array.isArray(m.team1) && Array.isArray(m.team2)) {
            s += `${m.team1.join(', ')} vs ${m.team2.join(', ')}`;
          } else if (m.player1 && m.player2) {
            s += `${m.player1} vs ${m.player2}`;
          }
          s += ` | 승자: ${Array.isArray(m.winner) ? m.winner.join(', ') : (m.winner || '-')}`;
          if (m.score) s += ` | 스코어: ${m.score}`;
          row.textContent = s;
          det.appendChild(row);
        });
      }

      box.appendChild(head);
      box.appendChild(det);
      list.appendChild(box);

      // 기본 접힘 상태
      det.style.display = 'none';
      box.addEventListener('click', () => {
        det.style.display = det.style.display === 'none' ? 'block' : 'none';
      });
    });
  }

  start();
</script>

</body>
</html>
