<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockClan Records</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <style>
    :root{ --bg1:#0b0710;--bg2:#14050a;--accent:#ff6a00;--muted:#a7a0a8;--card:rgba(255,255,255,0.03); }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;margin:0;color:#eee;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    header h1{margin:0;color:var(--accent)}
    header .sub{color:var(--muted);font-size:13px;margin-top:6px}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#14141a;position:sticky;top:0;z-index:2}
    nav button{background:#1a1a22;border:1px solid #232532;color:#ddd;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--accent);color:#111}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:center}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.03)}
    .tier-Stone{color:#8b8b8b}.tier-Bronze{color:#cd7f32}.tier-Silver{color:#c0c0c0}.tier-Gold{color:#ffd700}.tier-Diamond{color:#67e8f9}.tier-Legend{color:#ff7f50}
    .muted{color:var(--muted)}
    .match{border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px;cursor:pointer}
    .details{display:none;margin-top:8px;font-size:14px;color:#ddd}
    .details.active{display:block}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .filters > *{flex:1 1 160px}
    .rank-badge{background:#252532;border:1px solid #2f3140;border-radius:8px;padding:2px 8px;font-weight:700;display:inline-block;margin-right:6px}
  </style>
</head>
<body>
  <header>
    <h1>RockClan Records</h1>
    <div class="sub">클랜원 랭킹 • 기록실 • ELO 설명 • 변동 그래프</div>
  </header>

  <nav>
    <button class="tab active" data-tab="players">클랜원 랭킹</button>
    <button class="tab" data-tab="records">기록실</button>
    <button class="tab" data-tab="elo-info">ELO 시스템 설명</button>
    <button class="tab" data-tab="chart">ELO 변동 그래프</button>
  </nav>

  <main>
    <section id="players" class="active">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">클랜원 랭킹</h2>
        <div class="filters">
          <input id="search" placeholder="id 검색" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
          <select id="raceFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
            <option value="">종족 전체</option><option>Protoss</option><option>Terran</option><option>Zerg</option><option>Random</option>
          </select>
          <select id="tierFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
            <option value="">티어 전체</option><option>Stone</option><option>Bronze</option><option>Silver</option><option>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </div>
        <div class="muted" style="font-size:13px;margin-bottom:6px">전체 인원, 종족/티어, 현재 ELO, 승률(%) — <span id="counts"></span></div>
        <table id="players-table">
          <thead><tr><th>Rank</th><th>ID</th><th>종족</th><th>티어</th><th>ELO</th><th>승</th><th>패</th><th>승률</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="records">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">기록실 (Matchday 접기/펼치기)</h2>
        <div id="match-list"></div>
      </div>
    </section>

    <section id="elo-info">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ELO 시스템 설명</h2>
        <p>초기 ELO는 <b>1000</b>, 개인전 <b>K=24</b>, 팀전은 <b>60%</b> 반영. 티어보정: <code>1+0.2×Δindex</code></p>
      </div>
    </section>

    <section id="chart">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ELO 변동 그래프</h2>
        <div id="elo-chart" style="width:100%;height:440px"></div>
      </div>
    </section>
  </main>

  <script>
    // 탭 전환
    var tabs = document.querySelectorAll('nav .tab');
    for (var i=0;i<tabs.length;i++){
      tabs[i].addEventListener('click', function(e){
        for (var j=0;j<tabs.length;j++) tabs[j].classList.remove('active');
        e.currentTarget.classList.add('active');
        var secs = document.querySelectorAll('main section');
        for (var k=0;k<secs.length;k++) secs[k].classList.remove('active');
        document.getElementById(e.currentTarget.getAttribute('data-tab')).classList.add('active');
      });
    }

    function ensureRechartsReady(cb){
      var t=0; var h=setInterval(function(){
        t++; if(window.Recharts){clearInterval(h); cb();}
        if(t>60){clearInterval(h);}
      },100);
    }

    function groupByMatchday(matches){
      var groups=[]; var current=null; var md=0;
      for(var i=0;i<matches.length;i++){
        var m = matches[i];
        if(!current || current.date!==m.date || m.map==='Matchday'){
          if(m.map==='Matchday'){
            md = (current && current.date===m.date) ? md+1 : 1;
            current={date:m.date,index:md,header:m,sets:[]}; groups.push(current);
          } else {
            if(!current || current.date!==m.date){ md=1; current={date:m.date,index:md,header:null,sets:[]}; groups.push(current); }
          }
        }
        if(m.map==='Matchday'){ current.header=m; } else { current.sets.push(m); }
      }
      return groups;
    }

    // XHR로 data.json 로드 (BOM/캐시 대비)
    function loadJSON(url, onOk, onFail){
      var xhr=new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.overrideMimeType('application/json'); // 힌트
      xhr.onreadystatechange=function(){
        if(xhr.readyState===4){
          if(xhr.status>=200 && xhr.status<300){
            var txt=xhr.responseText || '';
            // BOM/숨은 제어문자 제거
            txt=txt.replace(/^\uFEFF/, '').replace(/\u0000/g,'');
            try { onOk(JSON.parse(txt)); }
            catch(err){ console.error('JSON parse error:', err); onFail && onFail(err); }
          } else { onFail && onFail(new Error('HTTP '+xhr.status)); }
        }
      };
      xhr.send(null);
    }

    var DATA_URL = 'data.json?v=20251017';

    loadJSON(DATA_URL, function(data){
      // Players
      var tbody=document.querySelector('#players-table tbody');
      var s=document.getElementById('search');
      var rf=document.getElementById('raceFilter');
      var tf=document.getElementById('tierFilter');

      function render(){
        tbody.innerHTML='';
        var kw=(s.value||'').toLowerCase();
        var race=rf.value;
        var tier=tf.value;

        // 복사 & 정렬
        var players=data.players.slice(0);
        players.sort(function(a,b){return b.elo-a.elo;});

        for(var i=0;i<players.length;i++){
          var p=players[i];
          if(kw && p.id.toLowerCase().indexOf(kw)===-1) continue;
          if(race && p.race!==race) continue;
          if(tier && p.tier!==tier) continue;

          var played=p.played||0, win=p.win||0, loss=p.loss||0;
          var wr = played ? (Math.round((win/played)*1000)/10).toFixed(1)+'%' : '-';

          var tr=document.createElement('tr');
          tr.innerHTML =
            '<td><span class="rank-badge">'+(tbody.children.length+1)+'</span></td>'+
            '<td>'+p.id+'</td>'+
            '<td>'+p.race+'</td>'+
            '<td class="tier-'+p.tier+'">'+p.tier+'</td>'+
            '<td>'+Math.round(p.elo)+'</td>'+
            '<td>'+win+'</td>'+
            '<td>'+loss+'</td>'+
            '<td>'+wr+'</td>';
          tbody.appendChild(tr);
        }
        document.getElementById('counts').textContent =
          'Players: '+data.players.length+' | Matches: '+data.matches.length;
      }
      s.addEventListener('input',render); rf.addEventListener('change',render); tf.addEventListener('change',render); render();

      // Records
      var list=document.getElementById('match-list');
      var matches=data.matches.slice(0);
      matches.sort(function(a,b){ return a.date<b.date ? -1 : (a.date>b.date ? 1 : 0); });
      var groups=groupByMatchday(matches);

      for(var g=0; g<groups.length; g++){
        var grp=groups[g];
        var box=document.createElement('div'); box.className='match';
        var head=document.createElement('div');

        var headHtml;
        if(grp.header){
          var w = grp.header.winner;
          headHtml = '<b>'+grp.date+'</b> | Matchday | 승자: ' +
                     (Object.prototype.toString.call(w)==='[object Array]' ? w.join(', ') : (w||'-')) +
                     ' | 스코어: ' + (grp.header.score||'-');
        }else{
          headHtml = '<b>'+grp.date+'</b> | 세트 모음';
        }
        head.innerHTML=headHtml;

        var det=document.createElement('div'); det.className='details';
        if(!grp.sets || grp.sets.length===0){
          det.innerHTML='<div class="muted">세트 기록 없음</div>';
        }else{
          for(var m=0;m<grp.sets.length;m++){
            var mm=grp.sets[m];
            var row=document.createElement('div');
            var text='• '+mm.map+' — ';
            if(mm.team1 && mm.team2){
              text += mm.team1.join(', ')+' vs '+mm.team2.join(', ');
              if(mm.winner){
                text += ' | 승자: '+(Object.prototype.toString.call(mm.winner)==='[object Array]'? mm.winner.join(', ') : mm.winner);
              }
            }else if(mm.player1 && mm.player2){
              text += mm.player1+' vs '+mm.player2;
              if(mm.winner) text += ' | 승자: '+mm.winner;
            }
            if(mm.score) text += ' | 스코어: '+mm.score;
            row.textContent=text;
            det.appendChild(row);
          }
        }
        box.appendChild(head); box.appendChild(det);
        (function(d){ box.addEventListener('click', function(){ d.classList.toggle('active'); }); })(det);
        list.appendChild(box);
      }

      // Chart
      ensureRechartsReady(function(){
        try{
          var RC=Recharts;
          var ppl=data.players.slice(0).sort(function(a,b){return b.elo-a.elo;}).slice(0,12);

          var series={};
          for(var i=0;i<ppl.length;i++){
            var p=ppl[i];
            var hist=p.history && p.history.length ? p.history : [p.elo];
            for(var j=0;j<hist.length;j++){
              if(!series[j]) series[j]={step:j};
              series[j][p.id]=hist[j];
            }
          }

          var keys=[]; for (var k in series) if(series.hasOwnProperty(k)) keys.push(k);
          keys.sort(function(a,b){return parseInt(a,10)-parseInt(b,10);});
          var chartData=[]; for(var ii=0;ii<keys.length;ii++) chartData.push(series[keys[ii]]);

          var lines=[];
          for(var li=0; li<ppl.length; li++){
            lines.push(React.createElement(RC.Line,{
              key:ppl[li].id, type:'monotone', dataKey:ppl[li].id,
              stroke:'hsl('+((li*37)%360)+',70%,60%)', strokeWidth:2, dot:false
            }));
          }

          ReactDOM.render(
            React.createElement(RC.ResponsiveContainer,{width:'100%',height:400},
              React.createElement(RC.LineChart,{data:chartData},
                React.createElement(RC.XAxis,{dataKey:'step'}),
                React.createElement(RC.YAxis,null),
                React.createElement(RC.Tooltip,null),
                React.createElement(RC.Legend,null)
              , lines) // children 배열로 전달
            ),
            document.getElementById('elo-chart')
          );
        }catch(e){ console.error(e); }
      });

    }, function(err){
      console.error('데이터 로드 실패:', err);
    });
  </script>
</body>
</html>
