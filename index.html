<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockClan Records</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%23222236'/%3E%3Cpath d='M82 30 56 64l26 34-18 0-26-34 26-34z' fill='%23ff6a00'/%3E%3C/svg%3E">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <style>
    :root{ --bg1:#0b0710;--bg2:#14050a;--accent:#ff6a00;--muted:#a7a0a8;--card:rgba(255,255,255,0.03); }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;margin:0;color:#eee;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    header h1{margin:0;color:var(--accent)}
    header .sub{color:var(--muted);font-size:13px;margin-top:6px}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#14141a;position:sticky;top:0;z-index:2}
    nav button{background:#1a1a22;border:1px solid #232532;color:#ddd;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--accent);color:#111}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:center}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.03)}
    .tier-Stone{color:#8b8b8b}.tier-Bronze{color:#cd7f32}.tier-Silver{color:#c0c0c0}.tier-Gold{color:#ffd700}.tier-Diamond{color:#67e8f9}.tier-Legend{color:#ff7f50}
    .muted{color:var(--muted)}
    .match{border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px;cursor:pointer}
    .details{display:none;margin-top:8px;font-size:14px;color:#ddd}
    .details.active{display:block}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .filters > *{flex:1 1 160px}
    .rank-badge{background:#252532;border:1px solid #2f3140;border-radius:8px;padding:2px 8px;font-weight:700;display:inline-block;margin-right:6px}
    .note{font-size:12px;color:#aaa;margin-top:6px}
  </style>
</head>

<body>
  <header>
    <h1>RockClan Records</h1>
    <div class="sub">클랜원 랭킹 • 기록실 • ELO 설명 • 변동 그래프</div>
  </header>

  <nav>
    <button class="tab active" data-tab="players">클랜원 랭킹</button>
    <button class="tab" data-tab="records">기록실</button>
    <button class="tab" data-tab="elo-info">ELO 시스템 설명</button>
    <button class="tab" data-tab="chart">ELO 변동 그래프</button>
  </nav>

  <main>
    <section id="players" class="active">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">클랜원 랭킹</h2>
        <div class="filters">
          <input id="search" placeholder="id 검색" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
          <select id="raceFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
            <option value="">종족 전체</option><option>Protoss</option><option>Terran</option><option>Zerg</option><option>Random</option>
          </select>
          <select id="tierFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff">
            <option value="">티어 전체</option><option>Stone</option><option>Bronze</option><option>Silver</option><option>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </div>
        <div class="muted" style="font-size:13px;margin-bottom:6px">전체 인원, 종족/티어, 현재 ELO, 승률(%) — <span id="counts"></span></div>
        <table id="players-table">
          <thead><tr><th>Rank</th><th>ID</th><th>종족</th><th>티어</th><th>ELO</th><th>승</th><th>패</th><th>승률</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="note">* 승/패/승률은 기록실(match)을 기반으로 자동 재계산됩니다.</div>
      </div>
    </section>

    <section id="records">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">기록실 (클릭하여 접기/펼치기)</h2>
        <div id="match-list"></div>
      </div>
    </section>
        <section id="elo-info">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ELO 시스템 설명</h2>
        <ul>
          <li>초기 ELO: <b>1000</b></li>
          <li>개인전 K-계수: <b>24</b> (팀전은 <b>60%</b> 반영)</li>
          <li>티어 보정 계수: <code>1 + 0.2 × ΔtierIndex</code></li>
          <li>랭킹 정렬 기준: 현재 ELO (상단 “클랜원 랭킹” 표)</li>
          <li>승/패/승률: 기록실 데이터를 다시 집계하여 표시 (기록이 우선)</li>
        </ul>

        <div class="muted" style="margin:8px 0 4px">티어 인덱스 예시: Stone 0, Bronze 1, Silver 2, Gold 3, Diamond 4, Legend 5</div>
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th style="border-bottom:1px solid rgba(255,255,255,0.1);padding:6px">매치업</th>
              <th style="border-bottom:1px solid rgba(255,255,255,0.1);padding:6px">ΔtierIndex</th>
              <th style="border-bottom:1px solid rgba(255,255,255,0.1);padding:6px">보정계수</th>
              <th style="border-bottom:1px solid rgba(255,255,255,0.1);padding:6px">이겼을 때</th>
              <th style="border-bottom:1px solid rgba(255,255,255,0.1);padding:6px">졌을 때</th>
            </tr>
          </thead>
          <tbody>
            <tr><td style="padding:6px">동일 티어 vs 동일 티어</td><td style="padding:6px">0</td><td style="padding:6px">1.0</td><td style="padding:6px">기본 K=24</td><td style="padding:6px">기본 K=24</td></tr>
            <tr><td style="padding:6px">한 단계↑ vs 한 단계↓</td><td style="padding:6px">+1/-1</td><td style="padding:6px">1.2 / 0.8</td><td style="padding:6px">아랫티어가 이기면 더 크게 +</td><td style="padding:6px">윗티어가 지면 더 크게 -</td></tr>
            <tr><td style="padding:6px">두 단계↑ vs 두 단계↓</td><td style="padding:6px">+2/-2</td><td style="padding:6px">1.4 / 0.6</td><td style="padding:6px">언더독 승리 시 큰 +</td><td style="padding:6px">강자 패배 시 큰 -</td></tr>
            <tr><td style="padding:6px">세 단계↑ vs 세 단계↓</td><td style="padding:6px">+3/-3</td><td style="padding:6px">1.6 / 0.4</td><td style="padding:6px">아주 큰 +</td><td style="padding:6px">아주 큰 -</td></tr>
          </tbody>
        </table>
        <div class="note">* 실제 증감은 상대 ELO, 예상승률 등에 따라 달라집니다. 위 표는 보정 계수의 방향성을 설명합니다.</div>
      </div>
    </section>
  </main>

<script>
  // 탭 전환
  document.querySelectorAll('nav .tab').forEach(btn=>{
    btn.addEventListener('click', e=>{
      document.querySelectorAll('nav .tab').forEach(b=>b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
      document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
    });
  });

  // --- 데이터 로드 ---
function start(){
  Promise.all([
    fetch('data.json', { cache: 'no-cache' }).then(r => r.json()),
    fetch('data_oct.json', { cache: 'no-cache' }).then(r => r.json())
  ])
  .then(([sep, oct]) => {
    sep.matches.push(...oct.matches);
    renderAll(sep);
  })
  .catch(e => console.error('로드 실패', e));
}

  // ✅ 날짜별 Match 그룹화
  function groupByDate(matches){
    const map = new Map();
    for(const m of matches){
      if(!map.has(m.date)) map.set(m.date, []);
      map.get(m.date).push(m);
    }
    return Array.from(map.entries()).map(([date, items]) => ({date, matches: items}));
  }

  // --- 렌더링 ---
  function renderAll(data){
    const tbody=document.querySelector('#players-table tbody');
    const s=document.getElementById('search');
    const rf=document.getElementById('raceFilter');
    const tf=document.getElementById('tierFilter');

    // ✅ ID 대소문자 무시
    const normalize = id => id ? id.trim().toLowerCase() : '';

    // ✅ 정확 승패 집계 (Match 헤더 제외)
    const stat = new Map();
    const ensure = id => {
      const key = normalize(id);
      return stat.get(key) || stat.set(key,{played:0,win:0,loss:0}).get(key);
    };
    const add = (winners, losers)=>{
      winners.forEach(id=>{const s=ensure(id); s.played++; s.win++;});
      losers.forEach(id=>{const s=ensure(id); s.played++; s.loss++;});
    };

    for(const m of data.matches){
      if(m.map === "Match") continue;
      if(m.player1 && m.player2){
        const p1=m.player1, p2=m.player2, w=m.winner;
        if(w===p1) add([p1],[p2]);
        else if(w===p2) add([p2],[p1]);
        else { ensure(p1).played++; ensure(p2).played++; }
        continue;
      }
      if(Array.isArray(m.team1)&&Array.isArray(m.team2)){
        const t1=m.team1,t2=m.team2;
        const winners=Array.isArray(m.winner)?m.winner:[];
        const wset=new Set(winners.map(normalize));
        const all=[...t1,...t2];
        const losers=all.filter(x=>!wset.has(normalize(x)));
        if(winners.length && losers.length) add(winners,losers);
        else all.forEach(id=>ensure(id).played++);
      }
    }

    for(const key of stat.keys()){
      let p = data.players.find(p => p.id.toLowerCase() === key);
      if(!p){
        p = {id:key, race:'Protoss', tier:'Silver', elo:1000, played:0, win:0, loss:0, history:[1000]};
        data.players.push(p);
      }
      const s = stat.get(key);
      p.played = s.played;
      p.win = s.win;
      p.loss = s.loss;
    }

    // --- 표 렌더링 ---
    function render(){
      tbody.innerHTML='';
      const kw=(s.value||'').toLowerCase(), race=rf.value, tier=tf.value;
      const sorted=[...data.players]
        .sort((a,b)=>b.elo-a.elo)
        .filter(p=>(!kw||p.id.toLowerCase().includes(kw))&&(!race||p.race===race)&&(!tier||p.tier===tier));
      sorted.forEach((p,i)=>{
        const wr=p.played?((p.win/p.played)*100).toFixed(1)+'%':'-';
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><span class="rank-badge">${i+1}</span></td>
          <td>${p.id}</td>
          <td>${p.race}</td>
          <td class="tier-${p.tier}">${p.tier}</td>
          <td>${Math.round(p.elo)}</td>
          <td>${p.win}</td>
          <td>${p.loss}</td>
          <td>${wr}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('counts').textContent=`Players: ${data.players.length} | Matches: ${data.matches.length}`;
    }
    s.addEventListener('input',render);
    rf.addEventListener('change',render);
    tf.addEventListener('change',render);
    render();

    // ✅ 기록실 (날짜별 헤더 + 기본 접힘 + Match 사이 간격)
    const list=document.getElementById('match-list');
    list.innerHTML='';
    const groups=groupByDate([...data.matches].sort((a,b)=>a.date.localeCompare(b.date)));

    groups.forEach((g)=>{
      const box=document.createElement('div');
      box.className='match';

      const matchCount = g.matches.filter(m => m.map === "Match").length || 0;
      const head=document.createElement('div');
      head.innerHTML=`<b>${g.date}</b> Match ${matchCount}`;
      head.style.cursor='pointer';

      const det=document.createElement('div');
      det.className='details';
      det.style.display='none';

      // --- Match 헤더와 세트 구분 ---
      const lines=[];
      g.matches.forEach((m,idx)=>{
        let s=`• ${m.map} — `;
        if(Array.isArray(m.team1) && Array.isArray(m.team2)){
          s+=`${m.team1.join(', ')} vs ${m.team2.join(', ')}`;
        }else if(m.player1 && m.player2){
          s+=`${m.player1} vs ${m.player2}`;
        }
        s+=` | 승자: ${Array.isArray(m.winner)?m.winner.join(', '):(m.winner||'-')}`;
        if(m.score) s+=` | 스코어: ${m.score}`;

        // 다음 Match 나오기 전에 한 줄만 띄움
        const isNextMatch = g.matches[idx+1] && g.matches[idx+1].map === "Match";
        const margin = isNextMatch ? 'margin-bottom:12px;' : '';
        lines.push(`<div style="${margin}">${s}</div>`);
      });
      det.innerHTML=lines.join('');

      head.addEventListener('click',()=>{
        det.style.display = (det.style.display==='none') ? 'block' : 'none';
      });

      box.appendChild(head);
      box.appendChild(det);
      list.appendChild(box);
    });
  }

  start();
</script>

</body>
</html>
